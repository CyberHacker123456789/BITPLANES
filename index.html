<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BIT-PLANES: REMASTERED</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; }
        canvas { display: block; image-rendering: pixelated; }
        #ui {
            position: absolute; inset: 0; display: flex; align-items: center; 
            justify-content: center; background: rgba(0,0,0,0.9); z-index: 20; color: #0f0;
        }
        .menu { border: 4px double #0f0; padding: 40px; text-align: center; background: #000; }
        .btn { 
            padding: 10px 20px; margin: 10px; cursor: pointer; border: 2px solid #0f0; 
            background: #000; color: #0f0; font-weight: bold; text-transform: uppercase;
        }
        .btn:hover { background: #0f0; color: #000; }
        .hidden { display: none !important; }
        .p1-color { color: #ff4444; } .p2-color { color: #4444ff; }
    </style>
</head>
<body>

<div id="ui">
    <div class="menu">
        <h1>BIT-PLANES</h1>
        <div id="step1">
            <p>PLAYER 1: SELECT SQUADRON</p>
            <button class="btn" onclick="setSide('red')">RED WING</button>
            <button class="btn" onclick="setSide('blue')">BLUE WING</button>
        </div>
        <div id="step2" class="hidden">
            <div style="display: flex; gap: 40px; text-align: left;">
                <div>
                    <h3 class="p1-color">P1 CONTROLS</h3>
                    W/A/D: Fly/Turn<br>X: Eject/Chute<br>C: Cannons<br>V: Missile
                </div>
                <div>
                    <h3 class="p2-color">P2 CONTROLS</h3>
                    Arrows: Fly/Turn<br>B: Eject/Chute<br>N: Cannons<br>M: Missile
                </div>
            </div>
            <p><i>LAND OR WALK TO THE CENTER BARN FOR REPAIRS</i></p>
            <button class="btn" style="width:100%" onclick="start()">ENGAGE</button>
        </div>
    </div>
</div>

<canvas id="stage"></canvas>

<script>
const canvas = document.getElementById('stage');
const ctx = canvas.getContext('2d');
const WORLD = 3000;
const BARN = { x: 1500, y: 1500 };
let p1, p2, active = false;
let colors = { p1: '', p2: '' };

const input = {};
window.onkeydown = e => input[e.code] = true;
window.onkeyup = e => input[e.code] = false;

function setSide(c) {
    colors.p1 = c;
    colors.p2 = c === 'red' ? 'blue' : 'red';
    document.getElementById('step1').className = 'hidden';
    document.getElementById('step2').className = '';
}

class BitPlane {
    constructor(x, y, color, side) {
        this.x = x; this.y = y; this.color = color;
        this.side = side;
        this.setupControls();
        this.spawn();
    }

    setupControls() {
        if(this.side === 1) this.keys = { u:'KeyW', l:'KeyA', r:'KeyD', x:'KeyX', f:'KeyC', m:'KeyV' };
        else this.keys = { u:'ArrowUp', l:'ArrowLeft', r:'ArrowRight', x:'KeyB', f:'KeyN', m:'KeyM' };
    }

    spawn() {
        this.state = 'air'; // air, chute, ground
        this.angle = this.side === 1 ? 0 : Math.PI;
        this.vel = 5;
        this.hp = 100;
        this.bullets = [];
        this.missiles = [];
        this.cooldown = 0;
    }

    update(opp) {
        if (this.state === 'air') {
            if (input[this.keys.l]) this.angle -= 0.08;
            if (input[this.keys.r]) this.angle += 0.08;
            this.x += Math.cos(this.angle) * this.vel;
            this.y += Math.sin(this.angle) * this.vel;
            
            if (input[this.keys.f] && this.cooldown <= 0) {
                this.bullets.push({x:this.x, y:this.y, a:this.angle, d:60});
                this.cooldown = 10;
            }
            if (input[this.keys.m] && this.cooldown <= 0) {
                this.missiles.push({x:this.x, y:this.y, a:this.angle, d:120, target:opp});
                this.cooldown = 30;
            }
            if (input[this.keys.x]) this.state = 'falling';
        } else if (this.state === 'falling' || this.state === 'chute') {
            if (input[this.keys.x] && this.state === 'falling') this.state = 'chute';
            this.y += (this.state === 'chute' ? 1 : 4);
            if (this.y > WORLD - 50) { this.y = WORLD - 50; this.state = 'ground'; }
        } else if (this.state === 'ground') {
            if (input[this.keys.l]) this.x -= 2;
            if (input[this.keys.r]) this.x += 2;
            if (input[this.keys.u]) this.y -= 2;
            if (input[this.keys.x] && this.y > WORLD - 100) this.y += 2; // S check
            
            if (Math.hypot(this.x - BARN.x, this.y - BARN.y) < 50) this.spawn();
        }

        this.cooldown--;
        this.bullets.forEach((b, i) => {
            b.x += Math.cos(b.a) * 12; b.y += Math.sin(b.a) * 12; b.d--;
            if (b.d < 0) this.bullets.splice(i, 1);
        });
        this.missiles.forEach((m, i) => {
            let dx = m.target.x - m.x, dy = m.target.y - m.y;
            let angleTo = Math.atan2(dy, dx);
            let diff = angleTo - m.a;
            while (diff < -Math.PI) diff += Math.PI*2;
            while (diff > Math.PI) diff -= Math.PI*2;
            m.a += diff * 0.08;
            m.x += Math.cos(m.a) * 8; m.y += Math.sin(m.a) * 8; m.d--;
            if (m.d < 0) this.missiles.splice(i, 1);
        });

        // World Wrap
        if (this.x < 0) this.x = WORLD; if (this.x > WORLD) this.x = 0;
        if (this.y < 0) this.y = WORLD; if (this.y > WORLD) this.y = 0;
    }

    draw(ctx, cx, cy) {
        ctx.save();
        ctx.translate(this.x - cx, this.y - cy);
        ctx.fillStyle = this.color;
        if (this.state === 'air') {
            ctx.rotate(this.angle);
            // Bitplanes chunky style
            ctx.fillRect(-12, -4, 24, 8); // Body
            ctx.fillRect(-4, -14, 8, 28); // Wings
            ctx.fillStyle = '#fff'; ctx.fillRect(4, -2, 4, 4); // Cockpit
        } else if (this.state === 'ground' || this.state === 'falling') {
            ctx.fillStyle = '#fff'; ctx.fillRect(-4, -8, 8, 16); // Pilot
        } else if (this.state === 'chute') {
            ctx.strokeStyle = '#fff'; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-15,-20); ctx.moveTo(0,0); ctx.lineTo(15,-20); ctx.stroke();
            ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(0, -25, 15, Math.PI, 0); ctx.fill();
            ctx.fillRect(-3,-5, 6, 10);
        }
        ctx.restore();
        
        this.bullets.forEach(b => { ctx.fillStyle = 'yellow'; ctx.fillRect(b.x-cx, b.y-cy, 4, 4); });
        this.missiles.forEach(m => { 
            ctx.fillStyle = 'orange'; ctx.beginPath(); ctx.arc(m.x-cx, m.y-cy, 5, 0, 7); ctx.fill(); 
            ctx.fillStyle = 'white'; ctx.fillRect(m.x-cx-2, m.y-cy-2, 4, 4);
        });
    }
}

function start() {
    document.getElementById('ui').classList.add('hidden');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    p1 = new BitPlane(1000, 1500, colors.p1, 1);
    p2 = new BitPlane(2000, 1500, colors.p2, 2);
    active = true;
    run();
}

function drawMap(ctx, cx, cy, w, h) {
    // Dirt/Grass floor
    ctx.fillStyle = '#1a1a1a'; ctx.fillRect(0, 0, w, h);
    ctx.strokeStyle = '#333';
    let step = 100;
    for(let x = -cx%step; x < w; x+=step) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
    for(let y = -cy%step; y < h; y+=step) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
    
    // THE BARN
    ctx.fillStyle = '#722'; ctx.fillRect(BARN.x-cx-60, BARN.y-cy-60, 120, 120);
    ctx.fillStyle = '#411'; ctx.fillRect(BARN.x-cx-20, BARN.y-cy+20, 40, 40); // Door
    ctx.strokeStyle = '#fff'; ctx.strokeRect(BARN.x-cx-60, BARN.y-cy-60, 120, 120);
}

function run() {
    if (!active) return;
    p1.update(p2); p2.update(p1);
    ctx.clearRect(0,0,canvas.width, canvas.height);

    const d = Math.hypot(p1.x-p2.x, p1.y-p2.y);
    if (d < 500) {
        let cx = (p1.x+p2.x)/2 - canvas.width/2;
        let cy = (p1.y+p2.y)/2 - canvas.height/2;
        drawMap(ctx, cx, cy, canvas.width, canvas.height);
        p1.draw(ctx, cx, cy); p2.draw(ctx, cx, cy);
    } else {
        // P1
        ctx.save(); ctx.beginPath(); ctx.rect(0,0,canvas.width/2, canvas.height); ctx.clip();
        drawMap(ctx, p1.x-canvas.width/4, p1.y-canvas.height/2, canvas.width/2, canvas.height);
        p1.draw(ctx, p1.x-canvas.width/4, p1.y-canvas.height/2);
        p2.draw(ctx, p1.x-canvas.width/4, p1.y-canvas.height/2);
        ctx.restore();
        // P2
        ctx.save(); ctx.translate(canvas.width/2, 0); ctx.beginPath(); ctx.rect(0,0,canvas.width/2, canvas.height); ctx.clip();
        drawMap(ctx, p2.x-canvas.width/4, p2.y-canvas.height/2, canvas.width/2, canvas.height);
        p1.draw(ctx, p2.x-canvas.width/4, p2.y-canvas.height/2);
        p2.draw(ctx, p2.x-canvas.width/4, p2.y-canvas.height/2);
        ctx.restore();
        ctx.fillStyle = '#0f0'; ctx.fillRect(canvas.width/2-2, 0, 4, canvas.height);
    }

    // Minimap
    ctx.setTransform(1,0,0,1,0,0);
    ctx.fillStyle = 'rgba(0,0,0,0.8)'; ctx.fillRect(10, 10, 150, 150);
    ctx.strokeStyle = '#0f0'; ctx.strokeRect(10, 10, 150, 150);
    let s = 150/WORLD;
    ctx.fillStyle = p1.color; ctx.fillRect(10+p1.x*s, 10+p1.y*s, 4, 4);
    ctx.fillStyle = p2.color; ctx.fillRect(10+p2.x*s, 10+p2.y*s, 4, 4);
    ctx.fillStyle = '#fff'; ctx.fillRect(10+BARN.x*s, 10+BARN.y*s, 4, 4);

    requestAnimationFrame(run);
}
</script>
</body>
</html>
