<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BITPLANES - RETRO</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; }
        canvas { 
            image-rendering: pixelated; 
            width: 100vw; height: 100vh; 
            object-fit: contain;
            background: #4488ff; /* Sky Blue */
            border: 4px solid #fff;
        }
        #ui {
            position: absolute; color: #fff; font-family: 'Courier New', monospace;
            text-align: center; background: rgba(0,0,0,0.9); padding: 20px; z-index: 10;
        }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="ui">
    <h1 style="color:#ffff00; text-shadow: 4px 4px #ff0000;">BITPLANES</h1>
    <div id="menu">
        <p>P1: WASD + C (Fire) + V (Missile) + X (Eject)</p>
        <p>P2: ARROWS + N (Fire) + M (Missile) + B (Eject)</p>
        <button onclick="start()" style="padding:10px; cursor:pointer; font-weight:bold;">START DOGFIGHT</button>
    </div>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

// Internal low-res resolution for pixel effect
const W = 400; 
const H = 240;
canvas.width = W;
canvas.height = H;

const WORLD_SIZE = 2000;
const BARN = { x: 1000, y: 1950 };
const keys = {};
window.onkeydown = e => keys[e.code] = true;
window.onkeyup = e => keys[e.code] = false;

class Pilot {
    constructor(x, y, color, controls) {
        this.x = x; this.y = y; this.color = color;
        this.controls = controls;
        this.reset();
    }
    reset() {
        this.mode = 'plane'; // plane, chute, walking
        this.angle = 0; this.v = 3; this.bullets = []; this.missiles = [];
        this.cooldown = 0; this.y = 1000;
    }
    update(opp) {
        if (this.mode === 'plane') {
            if (keys[this.controls.l]) this.angle -= 0.1;
            if (keys[this.controls.r]) this.angle += 0.1;
            this.x += Math.cos(this.angle) * this.v;
            this.y += Math.sin(this.angle) * this.v;
            if (keys[this.controls.f] && this.cooldown <= 0) {
                this.bullets.push({x:this.x, y:this.y, a:this.angle, life:30});
                this.cooldown = 8;
            }
            if (keys[this.controls.m] && this.cooldown <= 0) {
                this.missiles.push({x:this.x, y:this.y, a:this.angle, target:opp, life:100});
                this.cooldown = 50;
            }
            if (keys[this.controls.e]) { this.mode = 'falling'; }
        } else if (this.mode === 'falling' || this.mode === 'chute') {
            if (keys[this.controls.e] && this.mode === 'falling') this.mode = 'chute';
            this.y += (this.mode === 'chute' ? 0.5 : 2);
            if (this.y >= 1970) { this.y = 1970; this.mode = 'walking'; }
        } else {
            if (keys[this.controls.l]) this.x -= 1;
            if (keys[this.controls.r]) this.x += 1;
            if (Math.hypot(this.x - BARN.x, this.y - BARN.y) < 20) this.reset();
        }

        this.cooldown--;
        this.bullets.forEach((b, i) => {
            b.x += Math.cos(b.a) * 6; b.y += Math.sin(b.a) * 6; b.life--;
            if (b.life < 0) this.bullets.splice(i, 1);
        });
        this.missiles.forEach((m, i) => {
            let targetA = Math.atan2(m.target.y - m.y, m.target.x - m.x);
            m.a += (targetA - m.a) * 0.1;
            m.x += Math.cos(m.a) * 4; m.y += Math.sin(m.a) * 4; m.life--;
            if (m.life < 0) this.missiles.splice(i, 1);
        });

        // Loop world
        if (this.x < 0) this.x = WORLD_SIZE; if (this.x > WORLD_SIZE) this.x = 0;
    }

    draw(c, cx, cy) {
        c.save();
        c.translate(this.x - cx, this.y - cy);
        c.fillStyle = this.color;
        if (this.mode === 'plane') {
            c.rotate(this.angle);
            // Pixel Plane
            c.fillRect(-6, -2, 12, 4); // Fuselage
            c.fillRect(-2, -8, 4, 16); // Wings
            c.fillStyle = "#fff"; c.fillRect(2, -1, 2, 2); // Nose
        } else if (this.mode === 'falling' || this.mode === 'walking') {
            c.fillStyle = "#fff"; c.fillRect(-2, -4, 4, 8); // Man
        } else if (this.mode === 'chute') {
            c.fillStyle = "#fff"; c.fillRect(-8, -12, 16, 4); // Chute
            c.fillRect(-1, -8, 2, 8); // Strings
        }
        c.restore();
        this.bullets.forEach(b => { c.fillStyle = "yellow"; c.fillRect(b.x-cx, b.y-cy, 2, 2); });
        this.missiles.forEach(m => { c.fillStyle = "red"; c.fillRect(m.x-cx, m.y-cy, 3, 3); });
    }
}

let p1, p2;
function start() {
    document.getElementById('ui').classList.add('hidden');
    p1 = new Pilot(200, 1000, '#ff0000', {l:'KeyA', r:'KeyD', f:'KeyC', m:'KeyV', e:'KeyX'});
    p2 = new Pilot(1800, 1000, '#0000ff', {l:'ArrowLeft', r:'ArrowRight', f:'KeyN', m:'KeyM', e:'KeyB'});
    loop();
}

function drawBackground(c, cx, cy, w, h) {
    // Sky
    c.fillStyle = "#4488ff"; c.fillRect(0,0,w,h);
    // Ground
    let groundY = 1980 - cy;
    c.fillStyle = "#884400"; c.fillRect(0, groundY, w, 500);
    c.fillStyle = "#22aa22"; c.fillRect(0, groundY - 4, w, 4);
    // Barn
    c.fillStyle = "#aa2222"; c.fillRect(BARN.x - cx - 15, BARN.y - cy - 20, 30, 20);
    c.fillStyle = "#ffffff"; c.fillRect(BARN.x - cx - 5, BARN.y - cy - 10, 10, 10);
}

function loop() {
    p1.update(p2); p2.update(p1);
    ctx.clearRect(0,0,W,H);

    const dist = Math.abs(p1.x - p2.x);
    if (dist < 150) {
        let cx = (p1.x + p2.x)/2 - W/2;
        let cy = (p1.y + p2.y)/2 - H/2;
        drawBackground(ctx, cx, cy, W, H);
        p1.draw(ctx, cx, cy); p2.draw(ctx, cx, cy);
    } else {
        // Split Screen
        // Left
        ctx.save(); ctx.beginPath(); ctx.rect(0,0,W/2-1, H); ctx.clip();
        drawBackground(ctx, p1.x - W/4, p1.y - H/2, W/2, H);
        p1.draw(ctx, p1.x - W/4, p1.y - H/2);
        p2.draw(ctx, p1.x - W/4, p1.y - H/2);
        ctx.restore();
        // Right
        ctx.save(); ctx.translate(W/2+1, 0); ctx.beginPath(); ctx.rect(0,0,W/2, H); ctx.clip();
        drawBackground(ctx, p2.x - W/4, p2.y - H/2, W/2, H);
        p1.draw(ctx, p2.x - W/4, p2.y - H/2);
        p2.draw(ctx, p2.x - W/4, p2.y - H/2);
        ctx.restore();
        // Line
        ctx.fillStyle = "#fff"; ctx.fillRect(W/2-1, 0, 2, H);
    }

    // Minimap (Top Left)
    ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(5, 5, 50, 20);
    ctx.fillStyle = "#ff0000"; ctx.fillRect(5 + (p1.x/WORLD_SIZE)*50, 10, 2, 2);
    ctx.fillStyle = "#0000ff"; ctx.fillRect(5 + (p2.x/WORLD_SIZE)*50, 10, 2, 2);

    requestAnimationFrame(loop);
}
</script>
</body>
</html>
